<?php
include_once 'src/rsa.class.php';
include_once 'src/cfg.inc.php';

class cron{
	private $db;
	
	function __construct($cfg){
		$this->db = new PDO($cfg['dsn'], $cfg['user'], $cfg['passwd'], $cfg['options']);
		
	}
	
	function event($proc){
		
	}
	
	
}
class engine{
	
	private $buff;
	private $data;
	private $auth = false;
	private $len = 2048;
	private $db;
	
	private $my_public;
	private $my_private;
	private $other_public = array();
	private $i;
	
	
	function __call($name,$args){
		
	}
	
	
	function __construct($cfg){
		$this->db($cfg);
	}
	
	function socket(){
		$sock = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);
		//control port 9987
		socket_bind($sock, '127.0.0.1', '9987');
		while($cli = socket_accept($sock)){
			$this->client($cli);
		}
	}
	
	function client($cli){
		$this->seq[$this->i] = $cli;
		$buff = socket_read($cli, $this->len);
		$this->auth($cli,$buff);
		$this->i++;
	}
	
	function auth($cli,$buff){
		$filename = ".rsa/.pem";
		if(!file_exists($filename)){
			touch($filename);
			$keys = new RSA_keymaker();
			$this->db->query("insert into rsa_keys values ('".$_SERVER['HTTP_HOST']."','$keys[1]')");
			file_put_contents($filename, $keys[0]);
		}
		else{
			$this->my_private = file_get_contents($filename);
			$this->my_public = $this->db->query("select public from rsa_keys where domain='localhost'")->fetch();
		}
		$key = explode("\r\n", $buff);
		if(isset($key[1])){
			$this->db->query("insert into rsa_keys values ('$key[0]','$key[1]')");
			socket_write($cli, $_SERVER['HTTP_HOST']."\r\n".$keys[1]);
		}
		else{
			$this->other_public[$this->i] = $this->db->query("select public from rsa_keys where domain='$key[0]'")->fetch();
		}
		$this->listen($cli);
		
	}
	
	function db($cfg){
		$this->db = new PDO($cfg['dsn'], $cfg['user'], $cfg['passwd'], $cfg['options']);
	}
	
	function listen($cli){
		$data = socket_recvfrom($cli, $this->buff, $this->len);
		
	}
	
	function process(){
		
	}
	
}

class bot{
	
}


?>